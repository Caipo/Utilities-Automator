from web_scrape import get_gas, get_electricity
import csv
from datetime import date
import smtplib
from email.message import EmailMessage
from dotenv import load_dotenv
from dotenv import load_dotenv
import os
from messages import get_message
from openpyxl import load_workbook

load_dotenv()

gas = get_gas()
electricity = get_electricity()
internet = 45
utils_total = internet + gas + electricity
upstairs_fraction =  0.22
downstairs_fraction = 0.17

email_password  = os.getenv("EMAIL_PASSWORD")

def main():
    global gas, electricity, internet, utils_total
    # Varibles to be used later
   
    today = date.today()
    renters = [upstairs_a := Renter('mr.dino.rex@gmail.com', 1300, 'nick', True),
               upstairs_b := Renter('mr.dino.rex@gmail.com', 1360, 'shiva', True),
               downstairs_a := Renter('mr.dino.rex@gmail.com', 1350, 'philip', True),
               downstairs_b := Renter('mr.dino.rex@gmail.com', 1300, 'nick', True),
               master := Renter('mr.dino.rex@gmail.com', 1300, 'shivas', True)
              ]
              
    # This will add an entry to bills.csv
    exl_write([[
	    today.strftime("%B %d %Y"),
	    gas, 
        electricity,
        internet,
	    utils_total,
	    upstairs_a.total, 
	    upstairs_b.total,
	    downstairs_a.total,
	    downstairs_b.total,
        master.total
        ]], 
	    'bills.xlsx')
    
    # This will go through all the renters and send an email.
    for renter in renters:
        message = get_message(renter, gas, electricity, internet, upstairs_fraction, downstairs_fraction)

        email(renter.email, message)
    print('done')


class Renter():
    def __init__(self, email, rent, name, upstairs):
        global utils_total

        self.name = name
        self.rent = rent
        self.email = email
        self.upstairs = upstairs
        self.total = int(rent + utils_total) 


def email(to, content):
    global email_password 
    user = 'loansharkdon62@gmail.com'# Email were sending with
    try:
        smtp_server = smtplib.SMTP_SSL('smtp.gmail.com', 465)
        smtp_server.ehlo()
        smtp_server.login(user, email_password)
        smtp_server.sendmail(user, to, content)
        smtp_server.close()
        print ("Email sent successfully!")

    except Exception as ex:
        print ("Something went wrongâ€¦.",ex)

def exl_write(data, file_name):
    wb = load_workbook(os.getcwd() + '\\' + file_name)
    ws = wb.worksheets[0]
    for row_data in data:
        ws.append(row_data)
    wb.save(os.getcwd() + '\\' + file_name )


def csv_write(data , file_name): 
    for fields in data: 
        with open(file_name, 'a', encoding="utf-8", newline='') as f:
            writer = csv.writer(f) 
            writer.writerow(fields.values()) 
    f.close()

if __name__ == '__main__':
	main()

